!function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return t[i].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function i(t,e){var n=e({},t);return delete n["default"],n}function r(t,e){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i],o=Object.getOwnPropertyDescriptor(e,r);o&&o.configurable&&void 0===t[r]&&Object.defineProperty(t,r,o)}return t}Object.defineProperty(e,"__esModule",{value:!0});var o=n(1),a=n(2),s=n(24),h=n(26);window.GLPoint=o.GLPoint,window.GLPopMenu=a.GLPopMenu,window.GLBubbleView=s.GLBubbleView,window.GLBubbleView.sharedInstance,window.EPUBJS.BookInterface={},EPUBJS.BookInterface.textCopied=h.textCopied,EPUBJS.BookInterface.getText=h.getText,EPUBJS.BookInterface.createNote=h.createNote,EPUBJS.BookInterface.repaintNote=h.repaintNote,EPUBJS.BookInterface.updateNote=h.updateNote,EPUBJS.BookInterface;var u=n(29);r(e,i(u,r))},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0],i=arguments.length<=1||void 0===arguments[1]?0:arguments[1];n(this,t),this.x=e,this.y=i}return i(t,[{key:"isEqualTo",value:function(t){return t.x===this.x&&t.y===this.y}},{key:"converPoint",value:function(e){return new t(e.x-this.x,e.y-this.y)}}],[{key:"zero",value:function(){return new t}},{key:"copy",value:function(e){return new t(e.x,e.y)}}]),t}();e.GLPoint=r},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),a=function(t,e,n){for(var i=!0;i;){var r=t,o=e,a=n;s=u=h=void 0,i=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var h=s.get;return void 0===h?void 0:h.call(a)}var u=Object.getPrototypeOf(r);if(null===u)return void 0;t=u,e=o,n=a,i=!0}},s=n(3),h=n(5),u=(n(1),n(4),n(6)),c=u(),l=u(),f=function(t){function e(t){var n=this;if(i(this,e),t!==l)throw"大兄弟，俺是个单例类啊";a(Object.getPrototypeOf(e.prototype),"constructor",this).call(this),this.width=0,this.tapRanges=[],this.movedIndex=0,this.currentScale=this.currentAlpha=0,this.currentTranslate=30,this.isShow=!1,this.panel=this.createPanel(),this.svg=new s.GLSVG,this.addTapListener(this.svg.domElement,function(t){n.menuTapped(t)}),this.panel.appendChild(this.svg.domElement),this.tappedHandler=function(t){n.panelTapped(t)}}return r(e,t),o(e,[{key:"setMenuItems",value:function(t){this.parseItems(t)}},{key:"ifNeedsDisplay",value:function(t){this.isShow===!0?this.quitDisplay():(document.body.appendChild(this.panel),this.addTapListener(this.panel,this.tappedHandler),this.svg.setPosition(t),this.dispaly())}},{key:"dispaly",value:function(){this.isShow=!0,this.svg.domElement.style.opacity=this.currentAlpha=0,this.startAnimating()}},{key:"quitDisplay",value:function(){this.isShow=!1,this.startAnimating()}},{key:"stopAnimating",value:function(){a(Object.getPrototypeOf(e.prototype),"stopAnimating",this).call(this),this.isShow===!1&&(document.body.removeChild(this.panel),this.removeTapListener(this.panel,this.tappedHandler))}},{key:"enterFrame",value:function(){this.isAnimating=!0,this.isShow===!0?this.currentAlpha+=.07:this.currentAlpha-=.09,this.currentAlpha<0||this.currentAlpha>1?(this.currentAlpha=this.currentAlpha<0?0:1,this.stopAnimating()):a(Object.getPrototypeOf(e.prototype),"enterFrame",this).call(this),this.svg.domElement.style.opacity=this.currentAlpha}},{key:"panelTapped",value:function(t){t.preventDefault(),this.quitDisplay()}},{key:"menuTapped",value:function(t){t.preventDefault();var e,n,i=this.getTouchedPosition(t),r=this.svg.frame;e=i.x-r.x,n=i.y-r.y;for(var o=0;o<this.tapRanges.length;o++)if(e<this.tapRanges[o].to){this.tapRanges[o].callback(),this.quitDisplay();break}}},{key:"parseItems",value:function(t){this.tapRanges=[];for(var e=0,n=10,i=n,r=0;r<t.length;r++){var o=t[r].text,a=16*o.length+2*n,s=i+a;this.tapRanges[r]={text:o,from:i,to:s,center:i+a/2,callback:t[r].callback},e+=o.length,i=s}var h=this.tapRanges[t.length-1];h.to=h.to+n,this.width=h.to,this.svg.width=this.width,this.svg.textItems=this.tapRanges}},{key:"createPanel",value:function(){var t="position:fixed; z-index:20000; top:0px; left:0px; width:"+window.innerWidth+"px; height:"+window.innerHeight+"px;",e=document.createElement("div");return e.setAttribute("style",t),e}}],[{key:"instance",get:function(){return this[c]||(this[c]=new e(l)),this[c]}}]),e}(h.IAnimation);e.GLPopMenu=f},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=n(4),a=function(){function t(){i(this,t),this.isUpDirection=!1,this.minWidth=64,this.directionOffsetY=2,this.textItems=null,this.frame=new o.GLRect(100,100,64,50),this.marginLeft=5,this.marginRight=5,this.screenWidth=window.innerWidth,this.maxFrameX=this.screenWidth-this.marginRight,this.angleOffsetX=0,this.domElement=this.createSVGElement()}return r(t,[{key:"setPosition",value:function(t){this.frame.center=GLPoint.copy(t);var e=this.frame.height+this.directionOffsetY;t.y<e?(this.isUpDirection=!0,this.frame.y=t.y+this.directionOffsetY):(this.isUpDirection=!1,this.frame.y=t.y-e);var n=0;this.frame.x<this.marginLeft?(n=this.frame.x-this.marginLeft,this.frame.x=this.marginLeft):this.frame.getMaxX()>this.maxFrameX&&(n=this.frame.getMaxX()-this.maxFrameX,this.frame.x=this.maxFrameX-this.frame.width),this.angleOffsetX=this.validateAngleOffsetX(n),this.domElement.style.top=this.frame.y+"px",this.domElement.style.left=this.frame.x+"px",this.attachText(),this.calculateBorder()}},{key:"validateAngleOffsetX",value:function(t){var e=this.frame.halfWidth-13;return this.isUpDirection&&(t*=-1),-e>t?t=-e:t>e&&(t=e),t}},{key:"attachText",value:function(){var t=23;this.isUpDirection?(t=40,this.backgroundGroup.setAttribute("transform","translate("+this.frame.halfWidth+", "+this.frame.halfHeight+") rotate(180) translate("+-1*this.frame.halfWidth+", "+-1*this.frame.halfHeight+")")):this.backgroundGroup.setAttribute("transform","rotate(0)");for(var e=this.textGroup.querySelectorAll("text"),n=0;n<this.textItems.length;n++){var i=e[n];i.setAttribute("x",this.textItems[n].center),i.setAttribute("y",t),i.textContent=this.textItems[n].text}}},{key:"calculateBorder",value:function(){var t=3,e=6,n=10,i=.5,r=this.frame.width-1,o=.5,a=36,s=r/2+this.angleOffsetX,h="M"+(i+t)+" "+o+" L"+(r-t)+" "+o+" A"+t+" "+t+" 0 0 1 "+r+" "+(o+t)+" L"+r+" "+(a-t)+" A"+t+" "+t+" 0 0 1 "+(r-t)+" "+a+" L"+(s+n/2)+" "+a+" L"+s+" "+(a+e)+" L"+(s-n/2)+" "+a+" L"+(i+t)+" "+a+" A"+t+" "+t+" 0 0 1 "+i+" "+(a-t)+" L"+i+" "+(o+t)+" A"+t+" "+t+" 0 0 1 "+(i+t)+" "+o;this.borderPath.setAttribute("d",h)}},{key:"createSVGElement",value:function(){function t(t){return document.createElementNS(o,t)}function e(t,e,n){t.setAttributeNS(null,"x",e),t.setAttributeNS(null,"y",n)}function n(t,e){t.setAttributeNS(null,"style",e)}function i(t,e,n,i){t.setAttributeNS(null,"id",e),t.setAttributeNS(null,"width",n),t.setAttributeNS(null,"height",i)}function r(i,r,o){var s=t("use");return e(s,i,r),n(s,o),s.setAttributeNS(a,"href","#border"),s}var o="http://www.w3.org/2000/svg",a="http://www.w3.org/1999/xlink",s="-webkit-touch-callout: none; -webkit-user-select: none;-khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;-webkit-tap-highlight-color: rgba(255, 255, 255, 0);",h=t("svg");i(h,"glpopmenu",this.minWidth,this.frame.height),n(h,"cursor:hand; position: absolute; visibility:visiable;"+s);var u=t("symbol");u.setAttributeNS(null,"id","border"),this.borderPath=document.createElementNS(o,"path"),u.appendChild(this.borderPath),h.appendChild(u);var c=t("defs"),l=t("mask");i(l,"alphaMask","400","50");var f=t("rect");i(f,"rect","400","50"),n(f,"stroke:none; fill: #333333;"+s),l.appendChild(f),c.appendChild(l),h.appendChild(c);var p=r("0","2","fill:#000000;stroke-width:0; mask:url(#alphaMask);"),d=r("0","0","fill:#555;stroke:#353535;stroke-width:1;");this.backgroundGroup=t("g"),this.backgroundGroup.appendChild(p),this.backgroundGroup.appendChild(d),h.appendChild(this.backgroundGroup),this.textGroup=t("g"),n(this.textGroup,"font-size:16px;fill:#eeeeee;text-anchor: middle");for(var g=0;6>g;g++){var m=t("text");m.setAttributeNS(null,"x","0"),m.setAttributeNS(null,"y","23"),this.textGroup.appendChild(m)}return h.appendChild(this.textGroup),h}},{key:"width",set:function(t){this.frame.width=t<this.minWidth?this.minWidth:t,this.domElement.setAttribute("width",t)}}]),t}();e.GLSVG=a},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=n(1),a=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0],n=arguments.length<=1||void 0===arguments[1]?0:arguments[1],r=arguments.length<=2||void 0===arguments[2]?0:arguments[2],a=arguments.length<=3||void 0===arguments[3]?0:arguments[3];i(this,t),this._x=e,this._y=n,this._width=r,this._height=a,this.halfWidth=r/2,this.halfHeight=a/2,this._center=new o.GLPoint(e+this.halfWidth,n+this.halfHeight)}return r(t,[{key:"setPosition",value:function(t){this.x=t.x,this.y=t.y}},{key:"getPosition",value:function(){return new o.GLPoint(this.x,this.y)}},{key:"getMaxX",value:function(){return this.x+this._width}},{key:"getMaxY",value:function(){return this.y+this._height}},{key:"converPoint",value:function(t){return new o.GLPoint(t.x-this.x,t.y-this.y)}},{key:"convertRect",value:function(e){return new t(e.x-this.x,e.y-this.y,e.width,e.height)}},{key:"center",set:function(t){this._center=t,this._x=this._center.x-this.halfWidth,this._y=this._center.y-this.halfHeight},get:function(){return this._center}},{key:"width",set:function(t){this._width=t,this.halfWidth=t/2,this._center.x=this._x+this.halfWidth},get:function(){return this._width}},{key:"height",set:function(t){this._height=t,this.halfHeight=t/2,this._center.y=this._y+this.halfHeight},get:function(){return this._height}},{key:"x",set:function(t){this._x=t,this._center.x=this._x+this.halfWidth},get:function(){return this._x}},{key:"y",set:function(t){this._y=t,this._center.y=this._y+this.halfHeight},get:function(){return this._y}}]),t}();e.GLRect=a},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=n(1),a=function(){function t(){i(this,t),this.animationHandler=null,this.isAnimating=!1}return r(t,[{key:"startAnimating",value:function(){this.isAnimating=!0,this.requestAnimation()}},{key:"stopAnimating",value:function(){cancelAnimationFrame(this.animationHandler),this.isAnimating=!1}},{key:"enterFrame",value:function(){this.requestAnimation()}},{key:"requestAnimation",value:function(){var t=this;this.animationHandler=requestAnimationFrame(function(){t.enterFrame()})}},{key:"addTapListener",value:function(t,e){t.addEventListener("mouseup",e,!1),t.addEventListener("touchend",e,!1)}},{key:"removeTapListener",value:function(t,e){t.removeEventListener("mouseup",e,!1),t.removeEventListener("touchend",e,!1)}},{key:"destory",value:function(){this.stopAnimating()}},{key:"getTouchedPosition",value:function(t){return t.pageX?new o.GLPoint(t.pageX,t.pageY):new o.GLPoint(t.changedTouches[0].pageX,t.changedTouches[0].pageY)}}]),t}();e.IAnimation=a},function(t,e,n){"use strict";t.exports=n(7)()?Symbol:n(8)},function(t,e){"use strict";t.exports=function(){var t;if("function"!=typeof Symbol)return!1;t=Symbol("test symbol");try{String(t)}catch(e){return!1}return"symbol"==typeof Symbol.iterator?!0:"object"!=typeof Symbol.isConcatSpreadable?!1:"object"!=typeof Symbol.iterator?!1:"object"!=typeof Symbol.toPrimitive?!1:"object"!=typeof Symbol.toStringTag?!1:"object"!=typeof Symbol.unscopables?!1:!0}},function(t,e,n){"use strict";var i,r,o,a=n(9),s=n(22),h=Object.create,u=Object.defineProperties,c=Object.defineProperty,l=Object.prototype,f=h(null);"function"==typeof Symbol&&(i=Symbol);var p=function(){var t=h(null);return function(e){for(var n,i,r=0;t[e+(r||"")];)++r;return e+=r||"",t[e]=!0,n="@@"+e,c(l,n,a.gs(null,function(t){i||(i=!0,c(this,n,a(t)),i=!1)})),n}}();o=function(t){if(this instanceof o)throw new TypeError("TypeError: Symbol is not a constructor");return r(t)},t.exports=r=function d(t){var e;if(this instanceof d)throw new TypeError("TypeError: Symbol is not a constructor");return e=h(o.prototype),t=void 0===t?"":String(t),u(e,{__description__:a("",t),__name__:a("",p(t))})},u(r,{"for":a(function(t){return f[t]?f[t]:f[t]=r(String(t))}),keyFor:a(function(t){var e;s(t);for(e in f)if(f[e]===t)return e}),hasInstance:a("",i&&i.hasInstance||r("hasInstance")),isConcatSpreadable:a("",i&&i.isConcatSpreadable||r("isConcatSpreadable")),iterator:a("",i&&i.iterator||r("iterator")),match:a("",i&&i.match||r("match")),replace:a("",i&&i.replace||r("replace")),search:a("",i&&i.search||r("search")),species:a("",i&&i.species||r("species")),split:a("",i&&i.split||r("split")),toPrimitive:a("",i&&i.toPrimitive||r("toPrimitive")),toStringTag:a("",i&&i.toStringTag||r("toStringTag")),unscopables:a("",i&&i.unscopables||r("unscopables"))}),u(o.prototype,{constructor:a(r),toString:a("",function(){return this.__name__})}),u(r.prototype,{toString:a(function(){return"Symbol ("+s(this).__description__+")"}),valueOf:a(function(){return s(this)})}),c(r.prototype,r.toPrimitive,a("",function(){return s(this)})),c(r.prototype,r.toStringTag,a("c","Symbol")),c(o.prototype,r.toPrimitive,a("c",r.prototype[r.toPrimitive])),c(o.prototype,r.toStringTag,a("c",r.prototype[r.toStringTag]))},function(t,e,n){"use strict";var i,r=n(10),o=n(17),a=n(18),s=n(19);i=t.exports=function(t,e){var n,i,a,h,u;return arguments.length<2||"string"!=typeof t?(h=e,e=t,t=null):h=arguments[2],null==t?(n=a=!0,i=!1):(n=s.call(t,"c"),i=s.call(t,"e"),a=s.call(t,"w")),u={value:e,configurable:n,enumerable:i,writable:a},h?r(o(h),u):u},i.gs=function(t,e,n){var i,h,u,c;return"string"!=typeof t?(u=n,n=e,e=t,t=null):u=arguments[3],null==e?e=void 0:a(e)?null==n?n=void 0:a(n)||(u=n,n=void 0):(u=e,e=n=void 0),null==t?(i=!0,h=!1):(i=s.call(t,"c"),h=s.call(t,"e")),c={get:e,set:n,configurable:i,enumerable:h},u?r(o(u),c):c}},function(t,e,n){"use strict";t.exports=n(11)()?Object.assign:n(12)},function(t,e){"use strict";t.exports=function(){var t,e=Object.assign;return"function"!=typeof e?!1:(t={foo:"raz"},e(t,{bar:"dwa"},{trzy:"trzy"}),t.foo+t.bar+t.trzy==="razdwatrzy")}},function(t,e,n){"use strict";var i=n(13),r=n(16),o=Math.max;t.exports=function(t,e){var n,a,s,h=o(arguments.length,2);for(t=Object(r(t)),s=function(i){try{t[i]=e[i]}catch(r){n||(n=r)}},a=1;h>a;++a)e=arguments[a],i(e).forEach(s);if(void 0!==n)throw n;return t}},function(t,e,n){"use strict";t.exports=n(14)()?Object.keys:n(15)},function(t,e){"use strict";t.exports=function(){try{return Object.keys("primitive"),!0}catch(t){return!1}}},function(t,e){"use strict";var n=Object.keys;t.exports=function(t){return n(null==t?t:Object(t))}},function(t,e){"use strict";t.exports=function(t){if(null==t)throw new TypeError("Cannot use null or undefined");return t}},function(t,e){"use strict";var n=Array.prototype.forEach,i=Object.create,r=function(t,e){var n;for(n in t)e[n]=t[n]};t.exports=function(t){var e=i(null);return n.call(arguments,function(t){null!=t&&r(Object(t),e)}),e}},function(t,e){"use strict";t.exports=function(t){return"function"==typeof t}},function(t,e,n){"use strict";t.exports=n(20)()?String.prototype.contains:n(21)},function(t,e){"use strict";var n="razdwatrzy";t.exports=function(){return"function"!=typeof n.contains?!1:n.contains("dwa")===!0&&n.contains("foo")===!1}},function(t,e){"use strict";var n=String.prototype.indexOf;t.exports=function(t){return n.call(this,t,arguments[1])>-1}},function(t,e,n){"use strict";var i=n(23);t.exports=function(t){if(!i(t))throw new TypeError(t+" is not a symbol");return t}},function(t,e){"use strict";t.exports=function(t){return t&&("symbol"==typeof t||"Symbol"===t["@@toStringTag"])||!1}},function(t,e,n){"use strict";function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),a=function(t,e,n){for(var i=!0;i;){var r=t,o=e,a=n;s=u=h=void 0,i=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var h=s.get;return void 0===h?void 0:h.call(a)}var u=Object.getPrototypeOf(r);if(null===u)return void 0;t=u,e=o,n=a,i=!0}},s=(n(1),n(25)),h=n(4),u=n(5),c=function g(){var t=arguments.length<=0||void 0===arguments[0]?0:arguments[0],e=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=arguments.length<=2||void 0===arguments[2]?0:arguments[2],i=arguments.length<=3||void 0===arguments[3]?0:arguments[3];r(this,g),this.top=t,this.left=e,this.bottom=n,this.right=i},l=n(6),f=l(),p=l(),d=function(t){function e(t){var n=this;if(r(this,e),t!==p)throw"GLBubbleView 是单例类，调用方法：GLBubbleView.sharedInstance";a(Object.getPrototypeOf(e.prototype),"constructor",this).call(this),this.isShow=!1,this.isUpDirection=!1,this.directionOffsetY=9,this.cornerRadius=6,this.frame=new h.GLRect(0,0,100,60),this.angleFrame=new h.GLRect(0,0,10,7),this.marginLeft=5,this.marginRight=5,this.maxFrameX=window.innerWidth-this.marginRight,this.fontSize=16,this.lineHeight=18,this.content=null,this.contentSize=s.GLSize.zero(),this.contentMargin=new c(12,12,10,12),this.contentDiv=this.createContentDiv(),this.panel=this.createPanel(window.innerWidth,window.innerHeight),this.panel.appendChild(this.contentDiv),this.initCanvas(),this.tappedHandler=function(t){n.tapped(t)}}return i(e,t),o(e,[{key:"ifNeedsDisplay",value:function(t,e,n,i){this.isShow===!0?this.hidden():(this.content=t,this.anglePosition=e,this.tappedInnerCallback=n,this.tappedOuterCallback=i,this.show())}},{key:"show",value:function(){this.isShow=!0,this.currentAlpha=0;var t=this.getTextPixelLength(this.content);this.updateContent(t),this.updateBubbleSize(this.anglePosition),this.updateBubbleGraph(),document.body.appendChild(this.panel),this.addTapListener(this.panel,this.tappedHandler),this.startAnimating()}},{key:"hidden",value:function(){this.isShow=!1,this.removeTapListener(this.panel,this.tappedHandler),document.body.removeChild(this.panel),a(Object.getPrototypeOf(e.prototype),"stopAnimating",this).call(this)}},{key:"stopAnimating",value:function(){this.isShow===!1}},{key:"enterFrame",value:function(){this.isAnimating=!0,this.isShow===!0?this.currentAlpha+=.07:this.currentAlpha-=.09,this.stage.alpha=this.currentAlpha,this.contentDiv.opacity=this.currentAlpha,this.renderer.render(this.stage),this.currentAlpha<0||this.currentAlpha>1?(this.currentAlpha=this.currentAlpha<0?0:1,this.stopAnimating()):a(Object.getPrototypeOf(e.prototype),"enterFrame",this).call(this)}},{key:"tapped",value:function(t){t.preventDefault();var e=this.getTouchedPosition(t),n=new PIXI.Point(e.x-window.pageXOffset,e.y-window.pageYOffset);this.graphics.containsPoint(n)?"function"==typeof this.tappedInnerCallback&&this.tappedInnerCallback():"function"==typeof this.tappedOuterCallback&&this.tappedOuterCallback(),this.hidden()}},{key:"updateContent",value:function(t){if(100>=t)this.contentSize.width=t,this.contentSize.height=this.fontSize;else if(200>=t)this.contentSize.width=100,this.contentSize.height=2*this.lineHeight;else if(300>=t)this.contentSize.width=100,this.contentSize.height=3*this.lineHeight;else{var e=t/3;this.contentSize.width=e,this.contentSize.height=3*this.lineHeight;var n=300-this.contentMargin.left-this.contentMargin.right;e>n&&(this.contentSize.width=n)}this.contentDiv.innerHTML=this.content,this.contentDiv.style.width=this.contentSize.width+"px",this.contentDiv.style.height=this.contentSize.height+"px"}},{key:"updateBubbleSize",value:function(t){this.frame.width=this.contentSize.width+this.contentMargin.left+this.contentMargin.right,this.frame.height=this.contentSize.height+this.contentMargin.top+this.contentMargin.bottom,this.frame.x=t.x-this.frame.halfWidth;var e=this.frame.height+this.directionOffsetY+this.angleFrame.height;t.y<e?(this.isUpDirection=!0,this.angleFrame.y=t.y+this.directionOffsetY,this.frame.y=this.angleFrame.y+this.angleFrame.height):(this.isUpDirection=!1,this.frame.y=t.y-e,this.angleFrame.y=this.frame.getMaxY()),this.angleFrame.x=(this.frame.width-this.angleFrame.width)/2,this.frame.x<this.marginLeft?(this.angleFrame.x-=this.marginLeft-this.frame.x,this.frame.x=this.marginLeft):this.frame.getMaxX()>this.maxFrameX&&(this.angleFrame.x+=this.frame.getMaxX()-this.maxFrameX,this.frame.x=this.maxFrameX-this.frame.width),this.angleFrame.x=this.validateAngleOffsetX(this.angleFrame.x),this.angleFrame.x+=this.frame.x,this.contentDiv.style.top=this.frame.y+this.contentMargin.top+"px",this.contentDiv.style.left=this.frame.x+this.contentMargin.left+"px"}},{key:"validateAngleOffsetX",value:function(t){var e=this.frame.width-this.angleFrame.width-this.cornerRadius/2;return t>e?t=e:t<this.cornerRadius&&(t=this.cornerRadius),t}},{key:"getTextPixelLength",value:function(t){for(var e=0,n=0;n<t.length;n++){var i=(t.charAt(n),t.charCodeAt(n));e+=this.isDbcCase(i)?this.fontSize/2:this.fontSize}return e}},{key:"isDbcCase",value:function(t){return t>=32&&127>=t?!0:t>=65377&&65439>=t?!0:!1}},{key:"createPanel",value:function(t,e){var n="position:fixed; z-index:10000; top:0px; left:0px; width:"+t+"px; height:"+e+"px;";return this.createDiv(n)}},{key:"createContentDiv",value:function(){var t="position:absolute; z-index:20000; overflow:auto; word-wrap:break-word; word-break:break-all; padding:0px; color:#252525; font-size:"+this.fontSize+"px; line-height:"+this.lineHeight+"px; left:"+this.contentMargin.left+"px; top:"+this.contentMargin.top+"px;";return this.createDiv(t)}},{key:"createDiv",value:function(t){var e=document.createElement("div");return e.setAttribute("style",t),e}},{key:"initCanvas",value:function(){this.renderer=PIXI.autoDetectRenderer(window.innerWidth,window.innerHeight,{transparent:!0,resolution:window.devicePixelRatio}),this.renderer.view.setAttribute("style","position:absolute; z-index:15000; left:0px; top:0px; width:"+window.innerWidth+"px; height: "+window.innerHeight+"px"),this.panel.appendChild(this.renderer.view),this.stage=new PIXI.Container,this.graphics=new PIXI.Graphics,this.shadow=new PIXI.Graphics}},{key:"updateBubbleGraph",value:function(){this.drawBubbleView(this.shadow,0),this.shadow.alpha=.1,this.drawBubbleView(this.graphics,16313013);var t=2;this.isUpDirection&&(t=-2),this.shadow.y=this.graphics.y+t,this.stage.addChild(this.shadow),this.stage.addChild(this.graphics)}},{key:"drawBubbleView",value:function(t,e){t.clear(),t.beginFill(e),t.drawRoundedRect(this.frame.x,this.frame.y,this.frame.width,this.frame.height,this.cornerRadius);var n=void 0,i=void 0;this.isUpDirection?(n=this.angleFrame.y,i=this.angleFrame.getMaxY()):(n=this.angleFrame.getMaxY(),i=this.angleFrame.y),t.moveTo(this.angleFrame.x,i),t.lineTo(this.angleFrame.center.x,n),t.lineTo(this.angleFrame.getMaxX(),i),t.endFill()}}],[{key:"sharedInstance",get:function(){return this[f]||(this[f]=new e(p)),this[f]}}]),e}(u.IAnimation);e.GLBubbleView=d},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0],i=arguments.length<=1||void 0===arguments[1]?0:arguments[1];n(this,t),this.width=e,this.height=i}return i(t,null,[{key:"zero",value:function(){return new t}}]),t}();e.GLSize=r},function(t,e,n){"use strict";function i(){var t=EPUBJS.DomUtil.getSelection(h.NoteManager.sharedInstance.view),e=t.getRangeAt(0),n=e.toString();EPUBJS.core.postMessageToMobile("textCopy",n)}function r(){var t=EPUBJS.DomUtil.getSelection(h.NoteManager.sharedInstance.view),e=t.getRangeAt(0),n=e.toString();h.NoteManager.sharedInstance.currentRangeClone=e.cloneRange(),EPUBJS.core.postMessageToMobile("selectedText",n)}function o(t){var e,n,i,r,o,a=EPUBJS.DomUtil.getSelection(h.NoteManager.sharedInstance.view),s=a.getRangeAt(0);s||(s=h.NoteManager.sharedInstance.currentRangeClone);var u=s.toString();if(0!=u.length){e=s.startContainer,n=s.endContainer,o=s.commonAncestorContainer,i=s.startOffset,r=s.endOffset;var c=h.NoteManager.sharedInstance._applyInlineStyle(u,t,e,n,i,r,o,!0);EPUBJS.core.postMessageToMobile("createNote",c)}}function a(t){var e=h.NoteManager.sharedInstance.view,n=e.doc;if(t&&t instanceof Array&&0!=t.length)for(var i=0;i<t.length;i++){var r=t[i];if(void 0!=r.index&&r.index==e.currentChapter.spinePos){var o=EPUBJS.DomUtil.findNode(n.body,r.parent),a=EPUBJS.DomUtil.findNode(o,r.startContainer),s=EPUBJS.DomUtil.findNode(o,r.endContainer),u=r.startOffset,c=r.endOffset,l=(r.tag,r.comment),f=r.text;setTimeout(function(){h.NoteManager.sharedInstance._applyInlineStyle(f,l,a,s,u,c,o,!1,r.dataId)},0)}}}function s(t,e){h.NoteManager.sharedInstance.updateNote(t,e),EPUBJS.core.postMessageToMobile("updateNote",!0)}Object.defineProperty(e,"__esModule",{value:!0}),e.textCopied=i,e.getText=r,e.createNote=o,e.repaintNote=a,e.updateNote=s;var h=n(27)},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=n(2),a=n(24),s=n(28),h=n(6),u=h(),c=h(),l=function(){function t(e){if(i(this,t),e!==c)throw"NoteManager NoteManager.sharedInstance";this.view=null,this.document=null,this.currentRangeClone=null,this.height=40,this.currentGroupID=null,this.popMenu=o.GLPopMenu.instance,this.popMenu.setMenuItems([{text:"编辑",callback:this.editANote.bind(this)},{text:"删除",callback:this.deleteANote.bind(this)}])}return r(t,[{key:"setSelectionRange",value:function(t){this.range=t}},{key:"getSelectionRange",value:function(){return this.range}},{key:"deleteANote",value:function(){this.clearInlineStyle(this.currentGroupID),EPUBJS.core.postMessageToMobile("deleteNote",this.currentGroupID)}},{key:"editANote",value:function(){EPUBJS.core.postMessageToMobile("editNote",t.sharedInstance.currentGroupID)}},{key:"updateNote",value:function(t,e){for(var n=this.document.createTreeWalker(this.document.body,NodeFilter.SHOW_ELEMENT,{acceptNode:function(e){return"div"===e.tagName.toLowerCase().trim()&&e.groupId==t?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}},!1);n.nextNode();)node=n.currentNode,node.data=e,console.log("Modified comment:"+e)}},{key:"clearInlineStyle",value:function(t){for(var e=this.document.createTreeWalker(this.document.body,NodeFilter.SHOW_ELEMENT,{acceptNode:function(e){return console.log("node:"+e),"div"===e.tagName.toLowerCase().trim()&&e.groupId==t?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}},!1),n=[];e.nextNode();){var i=e.currentNode;n.push(i)}for(var r=0;r<n.length;r++){var o=n[r];o.parentElement.removeChild(o)}}},{key:"_applyInlineStyle",value:function(e,n,i,r,o,h,u,c,l){function f(t){var e=t[0].y,n=[t[0]],i=[];if(1===t.length)return i.push(n),i;for(var r=1;r<t.length;r++){var o=t[r],a=o.y;e===a?n.push(o):(i.push(n),n=[t[r]],e=t[r].y),r===t.length-1&&i.push(n)}return i}function p(e){if(!e||0===e.length)return null;for(var n=[],i=l?l:EPUBJS.core.uuid(),r=function(e){e.preventDefault(),e.stopPropagation(),t.sharedInstance.currentGroupID=e.target.groupId;var n=e.target.getBoundingClientRect(),i=t.sharedInstance.view.render.padding.top,r=new GLPoint(n.left+n.width/2,n.top+i);t.sharedInstance.popMenu.ifNeedsDisplay(r)},o=0;o<e.length;o++){var a=s.createLineElement(i,e[o]);a.addEventListener("touchend",r,!1),n.push(a)}return n}function d(e,n,i){if(!n||0===n.trim().length)return null;var r=s.createNoteIconButton(i,n);return r.addEventListener("touchend",function(e){e.preventDefault(),e.stopPropagation(),t.sharedInstance.currentGroupID=i;var n=r.getBoundingClientRect(),o=t.sharedInstance.view.render.padding.top,s=new GLPoint(n.left+7,n.top+7+o);a.GLBubbleView.sharedInstance.ifNeedsDisplay(e.target.data,s,t.sharedInstance.editANote,null)},!1),1==e.length?(r.style.top=Math.floor(e[0].y+e[0].height/2)-6+"px",r.style.left=(t.sharedInstance.view.chapterPos-1)*t.sharedInstance.view.pageWidth+e[0].x+e[0].width+"px"):(r.style.top=Math.floor(e[e.length-1].y+e[e.length-1].height/2)-6+"px",r.style.left=(t.sharedInstance.view.chapterPos-1)*t.sharedInstance.view.pageWidth+e[e.length-1].x+e[e.length-1].width+"px"),r}for(var g=this,m=EPUBJS.DomUtil.getAllTextNode(u),v=EPUBJS.DomUtil.getCoordinate(i,r,o,h,m),y=f(v),b=p(y),w=d.call(g,y[y.length-1],n,b[0].groupId),x=0;x<b.length;x++)g.document.body.appendChild(b[x]);if(w&&g.document.body.appendChild(w),c){var S=EPUBJS.DomUtil.getPosition(g.document.body,u),P=EPUBJS.DomUtil.getPosition(u,i),k=EPUBJS.DomUtil.getPosition(u,r),I=b[0].groupId,O={dataId:I,index:g.view.currentChapter.spinePos,startContainer:P,endContainer:k,startOffset:o,endOffset:h,parent:S,time:(new Date).getTime(),tag:"comment",text:e,comment:n,chapterName:g.view.chapterName.innerText};return O}}}],[{key:"sharedInstance",get:function(){return this[u]||(this[u]=new t(c)),this[u]}}]),t}();e.NoteManager=l},function(t,e,n){"use strict";
function i(t,e){var n=document.createElement("div");return n.groupId=t,n.style.height="20px",n.style.width="33px",n.style.position="absolute",n.data=e,n.innerHTML='<img align="middle" width="12" height="12" src="/app/hooks/biji.png" />',n}function r(t,e){var n=document.createElement("div");if(n.style.borderBottom="2px solid rgb(255, 96, 0)",n.style.position="absolute",n.groupId=t,1==e.length)n.style.height=e[0].height+"px",n.style.width=e[0].width+"px",n.style.top=e[0].y+"px",n.style.left=(o.NoteManager.sharedInstance.view.chapterPos-1)*o.NoteManager.sharedInstance.view.pageWidth+e[0].x+"px";else{var i=e.length,r=e[0].x,a=e[i-1].x;n.style.height=e[0].height+"px",n.style.width=a-r+e[i-1].width+"px",n.style.top=e[0].y+"px",n.style.left=(o.NoteManager.sharedInstance.view.chapterPos-1)*o.NoteManager.sharedInstance.view.pageWidth+e[0].x+"px"}return n}Object.defineProperty(e,"__esModule",{value:!0}),e.createNoteIconButton=i,e.createLineElement=r;var o=n(27)},function(t,e,n){"use strict";var i=n(27);EPUBJS.Hooks.register("beforeChapterDisplay").img=function(t){console.log("test es6 export");var e=t.doc||t.document;i.NoteManager.sharedInstance.view=t,i.NoteManager.sharedInstance.document=e},EPUBJS.Hooks.register("selected").a=function(t,e){var n=t.document;n.body;alert("what")}}]);